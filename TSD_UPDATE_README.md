# Warehouse Camera - Обновления ТСД

## Статус реализации: ✅ ЗАВЕРШЕНО

## Реализованные возможности

### 1. Поддержка встроенного сканера ТСД ✅

Приложение автоматически определяет, запущено ли оно на устройстве ТСД (терминале сбора данных) и переключается на использование встроенного сканера штрихкодов.

#### Поддерживаемые устройства ТСД:
- **Ranger2K** (основная цель)
- iData серии
- Chainway серии  
- Urovo серии
- Другие ТСД с стандартными broadcast API

#### Как это работает:
1. При запуске `BarcodeScannerActivity` приложение проверяет тип устройства
2. Если обнаружен ТСД, показывается кнопка переключения между камерой и встроенным сканером
3. По умолчанию используется встроенный сканер ТСД (если доступен)
4. Пользователь может переключиться на камеру в любое время

#### Файлы изменений:
- `utils/ScannerUtils.kt` - новый класс для работы с ТСД
- `ui/scanner/BarcodeScannerActivity.kt` - обновлен для поддержки ТСД
- `layout/activity_barcode_scanner.xml` - добавлены элементы интерфейса
- `AndroidManifest.xml` - добавлены разрешения для BroadcastReceiver

### 2. Исправлено сохранение текстовых аннотаций ✅

Текстовые файлы с информацией о дефектах автоматически создаются и сохраняются при съемке фотографий.

#### Что исправлено:
1. `CameraActivity` теперь получает `DefectDetails` из Intent
2. При сохранении фото автоматически вызывается `FileUtils.saveTextFile()`
3. Пользователь получает уведомление об успешном сохранении аннотаций
4. В случае ошибки показывается соответствующее сообщение

#### Содержимое текстовых файлов:
- Артикул товара
- Категория дефекта (1-3)
- Причина дефекта
- Шаблон описания
- Подробное описание
- Мультиязычная поддержка (русский, китайский, английский)

#### Файлы изменений:
- `ui/CameraActivity.kt` - добавлено сохранение аннотаций
- `ui/ItemListActivity.kt` - передача DefectDetails в CameraActivity
- `values/strings.xml` - новые сообщения пользователю

## Технические детали

### API для ТСД сканеров

#### Ranger2K:
```kotlin
scannerAction = "scan.rcv.message"
barcodeExtra = "barocode"
triggerAction = "com.android.server.scannerservice.broadcast"
```

#### Автоматическое определение ТСД:
```kotlin
fun isTSDDevice(): Boolean {
    val deviceModel = Build.MODEL.lowercase()
    // Проверка по модели, производителю и продукту
    return deviceModel.contains("ranger") || 
           deviceModel.contains("pda") ||
           // другие проверки...
}
```

### Жизненный цикл ТСД сканера:
1. `onCreate()` - определение типа устройства
2. `onResume()` - включение сканера
3. `onPause()` - отключение сканера  
4. `onDestroy()` - очистка ресурсов

### Сохранение аннотаций:
```kotlin
if (defectDetails != null) {
    val textSaved = FileUtils.saveTextFile(
        this, manufacturerInfo, articleInfo, defectDetails!!, itemData
    )
    // Обработка результата...
}
```

## Установка и использование

1. Скомпилируйте приложение с новыми изменениями
2. Установите на устройство Ranger2K или другое ТСД
3. При первом сканировании штрихкода приложение автоматически определит тип устройства
4. Используйте аппаратную кнопку сканирования или триггер на ТСД для чтения штрихкодов
5. Текстовые аннотации теперь сохраняются автоматически при создании фотографий

## Отладка

Для проверки работы ТСД функций:
```kotlin
ScannerUtils.showDeviceInfo(context) // Показать информацию об устройстве
```

Логи в Android Studio:
- `ScannerUtils` - информация о ТСД
- `BarcodeScannerActivity` - работа сканера
- `CameraActivity` - сохранение файлов
- `FileUtils` - создание файлов и директорий

## Обратная совместимость

Все изменения полностью совместимы с существующими функциями:
- На обычных телефонах используется камера как раньше
- Старый функционал сохранения фотографий не изменен
- Существующие файлы остаются доступными

## Возможные проблемы и решения

### ТСД сканер не работает:
1. Проверьте логи - определяется ли устройство как ТСД
2. Убедитесь что добавлены все необходимые разрешения в AndroidManifest.xml
3. Попробуйте переключиться на камеру через кнопку в интерфейсе

### Текстовые аннотации не сохраняются:
1. Проверьте разрешения на запись в память
2. Убедитесь что DefectDetails передается в CameraActivity
3. Проверьте логи FileUtils на наличие ошибок создания файлов

### Проблемы с разрешениями:
1. Android 10+ требует специальных разрешений для доступа к внешней памяти
2. Приложение автоматически переключается на внутреннее хранилище при необходимости

---

## Статус реализации

✅ **Все обновления успешно реализованы**

### Реализованные файлы:
- ✅ `ScannerUtils.kt` - класс для работы с ТСД сканерами
- ✅ `BarcodeScannerActivity.kt` - поддержка ТСД сканеров
- ✅ `FileUtils.kt` - улучшенное сохранение текстовых файлов
- ✅ `ImageUtils.kt` - автоматическая коррекция ориентации фото
- ✅ `ProductReceptionRepository.kt` - синхронизация с файловой системой
- ✅ `ItemListActivity.kt` - исправлена ошибка компиляции с импортом File

### Функциональность:
- ✅ Автоматическое определение ТСД устройств
- ✅ Поддержка встроенных сканеров ТСД
- ✅ Автоматическое сохранение текстовых аннотаций
- ✅ Коррекция ориентации фотографий
- ✅ Удаление фотографий из галереи
- ✅ Синхронизация списка приёмок

Приложение готово к использованию на ТСД устройствах!
